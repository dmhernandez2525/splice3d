# F3.3 Position Tracking

## Overview

The position tracking module provides job-level filament position
monitoring on top of the encoder system (F2.2). It reconciles motor
commanded positions with encoder-measured positions, logs drift events,
supports waypoint bookmarks, and tracks cumulative statistics across
an entire splicing job.

## Architecture

```
Position Tracking (F3.3)
    |
    +-- Encoder System (F2.2) -- raw ticks, slip detection, correction
    +-- Stepper Control (F2.1) -- commanded motor positions
```

The encoder system handles low-level tick counting and closed-loop
correction. Position tracking adds higher-level job awareness,
drift event classification, and waypoint management.

## Drift Detection

Drift is the difference between encoder-measured position and
the active motor's commanded position. Drift events are classified
by severity:

| Severity | Threshold | Action |
|----------|-----------|--------|
| MINOR | >= 0.5 mm | Logged |
| MODERATE | >= 1.5 mm | Logged with warning |
| SEVERE | >= 3.0 mm | Logged, serial alert |

Thresholds are configurable at runtime via `setDriftThresholds()`.

## Job Management

A position tracking "job" spans an entire splicing session:

```
startPositionJob()    -- begin tracking
  ... splicing operations ...
stopPositionJob()     -- finalize and report
```

While a job is active, the module tracks:
- Total distance traveled (mm)
- Peak velocity (mm/s)
- Maximum instantaneous drift (mm)
- Cumulative absolute drift (mm)
- Drift event count and history
- Waypoint bookmarks
- Encoder correction count

## Waypoints

Up to 32 waypoints can be recorded during a job. Each waypoint
captures:
- Timestamp (ms since job start)
- Encoder position (mm)
- Motor position (mm)
- Drift at capture time (mm)

Use `addWaypoint()` to record the current position.

## Position Snapshot

`getPositionSnapshot()` returns a real-time view:
- Encoder position (mm)
- Motor A position (mm)
- Motor B position (mm)
- Current drift (mm)
- Cumulative drift (mm)
- Velocity (mm/s)
- Job elapsed time (ms)

## Configuration

| Parameter | Default | Range |
|-----------|---------|-------|
| Tracking interval | 200 ms | 50-5000 ms |
| Minor drift threshold | 0.5 mm | > 0 |
| Moderate drift threshold | 1.5 mm | > minor |
| Severe drift threshold | 3.0 mm | > moderate |
| Max waypoints | 32 | compile-time |
| Max drift events | 16 | compile-time |

## Validation

```bash
python3 scripts/hardware/validate_f3_3.py
python3 -m unittest postprocessor.tests.test_position_tracking_validation -v
```
