# F2.3 Temperature Control

## Overview

Phase F2.3 upgrades the temperature subsystem with material-aware PID control, multi-stage heating, thermal safety, and diagnostics.

## Material Profiles

| Material | Target (C) | Min Motion (C) | Ramp Rate (C/s) | Soak (ms) |
|----------|-----------|----------------|-----------------|-----------|
| PLA      | 210       | 180            | 2.0             | 2000      |
| PETG     | 235       | 210            | 1.5             | 3000      |
| ABS      | 250       | 220            | 1.0             | 4000      |

## Heating Stages

1. **OFF** - Heater disabled, no PID control
2. **PREHEAT** - Ramping to target using configured ramp rate
3. **SOAK** - Holding at target for material-specific soak duration
4. **READY** - Temperature stable, splice can proceed
5. **FAULT** - Thermal safety triggered, heater off, fan forced on

## Safety Features

- **Thermal runaway detection**: If temperature does not rise at least 10C within 40 seconds while below target, fault triggers
- **Thermistor disconnect detection**: Readings below -10C or above 350C trigger immediate fault
- **Overtemperature shutoff**: Hard cutoff at 280C
- **Cold extrusion prevention**: Motor motion blocked when temp below 170C during active heating
- **PID watchdog**: If PID loop stops running for 2 seconds, fault triggers
- **Cooling fan on fault**: Fan automatically enabled at full speed on any thermal fault

## PID Auto-Tune

Uses the Ziegler-Nichols relay method:

1. Set target temperature: `TEMP 210`
2. Start auto-tune: `TEMP AUTOTUNE`
3. The system oscillates around the setpoint for 5 cycles
4. Optimal Kp, Ki, Kd values are computed and applied automatically

## Serial Commands

| Command | Description |
|---------|-------------|
| `TEMP` | Query full temperature telemetry |
| `TEMP <value>` | Set target temperature in Celsius |
| `TEMP MATERIAL PLA\|PETG\|ABS` | Select material profile |
| `TEMP PID <Kp> <Ki> <Kd>` | Set PID tunings manually |
| `TEMP AUTOTUNE` | Start PID auto-tune |
| `TEMP FAN <0-255>` | Set cooling fan PWM |
| `TEMP HEATER <0-255>` | Set heater PWM directly (disables PID) |

## Telemetry Output

At 1Hz, the firmware outputs:

```
TEMP_LOG C=205.3 T=210.0 S=208.5 PWM=180 STAGE=1
```

Fields: current temp, target temp, effective setpoint (ramped), PWM output, heating stage index.

## Validation

```bash
python3 scripts/hardware/validate_f2_3.py
python3 -m pytest postprocessor/tests/test_temperature_control_validation.py -v
```

## Files

| File | Description |
|------|-------------|
| `firmware/src/temperature.h` | Type definitions and API declarations |
| `firmware/src/temperature.cpp` | Core PID, safety, staging, telemetry |
| `firmware/src/temperature_autotune.cpp` | Ziegler-Nichols relay auto-tune |
| `firmware/src/serial_temperature.cpp` | TEMP serial subcommand handler |
| `hardware/f2_3/spec/temperature_control_validation.json` | Acceptance spec |
| `postprocessor/temperature_control_validation.py` | Python validation helpers |
| `scripts/hardware/validate_f2_3.py` | Validation runner script |
