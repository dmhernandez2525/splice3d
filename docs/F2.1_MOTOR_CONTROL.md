# F2.1 Motor Control

## Scope

This feature upgrades firmware motor control for feed A, feed B, and winder axes with runtime motion tuning, absolute and relative tracking, sensorless homing, synchronized motion, and diagnostics.

## Firmware Changes

1. `firmware/src/stepper_control.h`
   - Added advanced motor APIs, motion profiles, diagnostics structures, synchronized move control, and sensorless homing interface.
2. `firmware/src/stepper_control.cpp`
   - Implemented runtime motion engine with backlash compensation, position normalization for overflow handling, current and microstepping runtime tuning, diagnostics updates, and emergency stop behavior.
3. `firmware/src/stepper_compat.cpp`
   - Preserved legacy state-machine integration wrappers.
4. `firmware/src/tmc_config.h` and `firmware/src/tmc_config.cpp`
   - Added runtime microstepping configuration for TMC2209 UART control.

## Delivered Capabilities

1. Motion profile per axis with max speed, acceleration, and jerk-limited acceleration cap.
2. Absolute and relative moves with cumulative position tracking.
3. Position normalization to avoid long-run 32-bit position overflow drift.
4. Sensorless homing routine using StallGuard trigger checks.
5. Emergency stop that halts all axes and disables drivers.
6. Synchronized multi-axis move support for feed and winding operations.
7. Runtime microstepping mode support (`8`, `16`, `32`).
8. Runtime run-current and hold-current control flow.
9. Backlash compensation per axis on direction reversal.
10. Diagnostics for stall status, over-temp warning, missed-step estimate, and synchronized move state.

## Acceptance Validation Artifacts

1. `hardware/f2_1/spec/motor_control_validation.json`
2. `postprocessor/motor_control_validation.py`
3. `scripts/hardware/validate_f2_1.py`
4. `postprocessor/tests/test_motor_control_validation.py`

## Validation Commands

```bash
python3 scripts/hardware/validate_f2_1.py
python3 -m unittest postprocessor.tests.test_motor_control_validation -v
```
