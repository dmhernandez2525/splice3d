# F2.2 Encoder System

## Scope

This feature adds a full quadrature encoder subsystem with interrupt-driven decoding, velocity estimation, slip detection, closed-loop correction, calibration persistence, and health monitoring.

## Firmware Changes

1. `firmware/src/encoder_system.h`
   - Introduces encoder telemetry and health interfaces.
2. `firmware/src/encoder_system.cpp`
   - Implements quadrature decoding with transition validation and debounce filtering.
   - Adds ticks-to-mm conversion, rolling slip window, and closed-loop correction.
   - Adds calibration start/complete flow and EEPROM persistence.
   - Adds signal quality metrics and failure detection.
3. `firmware/src/main.cpp`
   - Initializes and updates encoder subsystem each loop.
4. `firmware/src/serial_handler.h`
   - Adds `ENCODER` command handler declaration.
5. `firmware/src/serial_handler.cpp`
   - Routes `ENCODER` command and extends `STATUS` output with encoder summary.
6. `firmware/src/serial_encoder.cpp`
   - Implements encoder command subprotocol.
7. `firmware/src/config.h`
   - Adds encoder channel, debounce, slip, correction, and telemetry constants.

## Delivered Capabilities

1. Hardware interrupt quadrature decoding on two channels.
2. Position tracking in millimeters from configurable ticks-per-mm calibration.
3. Velocity estimation from inter-edge timing with smoothing.
4. Slip detection from rolling position error windows.
5. Closed-loop correction using bounded correction moves.
6. Guided calibration (`CAL_START`, `CAL_COMPLETE`) and persistence in EEPROM.
7. Signal quality/degradation/failure health monitoring.
8. Configurable telemetry logging interval.

## Serial Commands

```text
ENCODER STATUS
ENCODER CAL_START <known_length_mm>
ENCODER CAL_COMPLETE
ENCODER TICKS_PER_MM <value>
ENCODER LOG_INTERVAL <ms>
ENCODER CLOSED_LOOP ON|OFF
ENCODER SAVE
ENCODER RESET_COUNTERS
```

## Acceptance Validation Artifacts

1. `hardware/f2_2/spec/encoder_system_validation.json`
2. `postprocessor/encoder_system_validation.py`
3. `scripts/hardware/validate_f2_2.py`
4. `postprocessor/tests/test_encoder_system_validation.py`

## Validation Commands

```bash
python3 scripts/hardware/validate_f2_2.py
python3 -m unittest postprocessor.tests.test_encoder_system_validation -v
```
