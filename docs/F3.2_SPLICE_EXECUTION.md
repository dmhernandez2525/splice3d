# F3.2 Splice Execution

## Overview

The splice execution engine orchestrates the complete filament splicing
sequence: retract filament A, advance filament B, heat, compress, hold,
cool, and verify bond quality via pull-test.

## Splice Phases

| Phase | Description |
|-------|-------------|
| IDLE | No splice in progress |
| RETRACT_A | Retracting filament A from the splice zone |
| ADVANCE_B | Advancing filament B into position |
| HEATING | Heating to material-specific target temperature |
| COMPRESSING | Synchronized compression of both filaments |
| HOLDING | Maintaining temperature and pressure for bonding |
| COOLING | Active cooling with fan until target reached |
| VERIFYING | Pull-test verification of bond quality |
| COMPLETE | Splice finished successfully |
| FAILED | Splice failed (timeout, quality check, or abort) |

## Material Profiles

| Material | Temperature | Compression | Hold Time | Cool Time |
|----------|-------------|-------------|-----------|-----------|
| PLA | 210 C | 2.0 mm | 2000 ms | 5000 ms |
| PETG | 235 C | 2.5 mm | 3000 ms | 6000 ms |
| ABS | 250 C | 3.0 mm | 4000 ms | 8000 ms |

## Quality Scoring

After cooling, a pull-test moves filament A backwards by a configurable
distance. Encoder slip is measured to determine bond quality:

- Slip < 0.5 mm: quality = 1.0 (excellent)
- Slip < 1.0 mm: quality = 0.8 (acceptable)
- Slip >= 1.0 mm: quality = 0.5 (marginal, still passes threshold)

The quality threshold for a passing splice is 0.5.

## Serial Commands

```
SPLICE START <material_index>   Start splice (0=PLA, 1=PETG, 2=ABS)
SPLICE ABORT                    Emergency abort current splice
SPLICE STATUS                   Query current phase and telemetry
SPLICE STATS                    Query cumulative statistics
SPLICE RESET_STATS              Reset statistics counters
```

## Telemetry

The `getSpliceTelemetry()` function returns:
- Current phase
- Current temperature
- Compression distance
- Elapsed time since splice start
- Estimated remaining time (computed from phase + profile)
- Quality score (set after verification)
- Pass/fail status

## Time Estimation

Remaining time is estimated per-phase:
- HEATING: uses `predictTimeToTargetSeconds()` plus hold + cool times
- HOLDING: remaining hold time plus cool time
- COOLING: remaining cool time
- Other phases: 0

## Statistics

Running averages are maintained for:
- Total attempts, successes, failures
- Average splice time (ms)
- Average quality score

## Acceptance Limits

| Parameter | Min | Max |
|-----------|-----|-----|
| PLA bond strength | 5 N | 100 N |
| PETG bond strength | 5 N | 100 N |
| ABS bond strength | 5 N | 100 N |
| Max splice time | 5000 ms | 120000 ms |

## Validation

```bash
python3 scripts/hardware/validate_f3_2.py
python3 -m pytest postprocessor/tests/test_splice_execution_validation.py -v
```
