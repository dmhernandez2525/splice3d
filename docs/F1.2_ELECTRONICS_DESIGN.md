# F1.2 Electronics Design

## Scope

This feature defines the electrical architecture for Splice3D on BTT SKR Mini E3 v2.0 with TMC2209, encoder feedback, PID heater control, cutter servo drive, and hardware safety cutoffs.

## Design Artifacts

1. Electronics spec: `hardware/f1_2/spec/electronics_design.json`
2. Validation module: `postprocessor/electronics_validation.py`
3. Validation script: `scripts/hardware/validate_f1_2.py`
4. Unit tests: `postprocessor/tests/test_electronics_validation.py`

## Controller Selection and Pin Plan

Primary controller:
1. Board: BTT SKR Mini E3 v2.0
2. MCU: STM32F103RCT6
3. Interface: USB serial at 115200 baud

Pinned peripherals:
1. Feed Motor A: `PB13` step, `PB12` dir
2. Feed Motor B: `PB10` step, `PB2` dir
3. Winder Motor: `PB0` step, `PC5` dir
4. Heater PWM: `PC8`
5. Thermistor ADC: `PA0`
6. Servo PWM: `PB3`
7. Encoder A/B: `PC0`, `PC1`
8. Emergency stop input: `PC2`
9. LCD: `EXP1`

## Stepper and Driver Circuit

TMC2209 UART control is enabled for X, Y, and Z channels.

Required behavior:
1. sensorless homing support
2. runtime current tuning, run `850mA`, hold `450mA`
3. UART diagnostics and fault reporting

## Encoder Interface Circuit

Quadrature encoder design includes:
1. 10k pull-up resistors on A and B channels
2. RC debounce network per channel, `1k` + `100nF`
3. Schmitt trigger conditioning via `74HC14`

This combination improves noise immunity while preserving edge timing for interrupt capture.

## PID Heater Control Circuit

Heater loop elements:
1. MOSFET: `AO3400A` for heater switching
2. NTC thermistor input: `100K 3950`
3. Thermal fuse: `128C` cutoff in heater power path
4. Heater cartridge: `24V 40W`

## Power Distribution

Two supported input modes are defined.

### 24V Mode

1. `VIN_24`: 24V at 8.0A max
2. `VREG_5`: 5V at 2.0A max

### 12V Mode

1. `VIN_12`: 12V at 10.0A max
2. `VREG_5`: 5V at 2.0A max

Loads are modeled per mode in the machine-readable spec and validated against rail capacities.

## Safety Cutoffs and Fault Controls

Required hardware protections:
1. thermal fuse on heater line
2. motor overcurrent protection
3. emergency stop switch input
4. reverse polarity protection on VIN
5. ESD clamps on USB, encoder, and serial connectors

## Servo Control Circuit

SG90 cutter control includes:
1. PWM command at 50Hz
2. signal conditioning with `SN74LVC1G17`
3. dedicated 5V BEC path for peak servo current

## Display Interface

Supported displays:
1. Ender LCD 128x64 via EXP1
2. I2C OLED 128x64

Displayed runtime fields:
1. splice temperature
2. job progress
3. active error code

## ESD Protection

External connectors with ESD devices:

| Connector | Type | Protection |
|-----------|------|------------|
| `usb_c` | USB-C | ESD9M5V |
| `encoder_jst` | JST-XH-4 | PESD5V |
| `serial_header` | JST-XH-3 | PESD5V |

## Wire Gauge and Connector Requirements

| Path | AWG | Max Current | Connector |
|------|-----|-------------|-----------|
| VIN and heater | 18 | 8.0A | Screw terminal |
| Stepper outputs | 22 | 2.0A | JST-XH-4 |
| Encoder and signal | 24 | 0.5A | JST-XH |
| Servo 5V branch | 22 | 1.5A | JST-XH-3 |

## Component Sourcing Redundancy

Critical components maintain two in-stock alternatives in the spec.

Tracked critical components:
1. BTT SKR Mini E3 v2.0
2. TMC2209
3. NTC 100K Thermistor

## Verification Commands

```bash
python3 scripts/hardware/validate_f1_2.py
python3 -m unittest postprocessor.tests.test_electronics_validation -v
```

Validation confirms:
1. DRC rule compliance for required subsystems and safety features
2. supplier availability redundancy for critical parts
3. 12V and 24V rail budgets within capacity limits
