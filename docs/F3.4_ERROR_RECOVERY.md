# F3.4 Error Recovery

## Overview

The error recovery engine manages automatic and user-guided recovery
sequences for all error conditions in the Splice3D firmware. It builds
on the existing ErrorHandler (error_handler.h) by adding stateful
recovery phases, cooldown management, retry budgets, and statistics.

## Recovery Phases

| Phase | Description |
|-------|-------------|
| IDLE | No recovery in progress |
| ASSESSING | Evaluating the error and choosing recovery action |
| COOLDOWN_WAIT | Waiting for temperature to drop before retry |
| RETRYING | Attempting automatic recovery |
| AWAITING_USER | Waiting for user to complete manual intervention |
| RESOLVED | Recovery completed successfully |
| UNRECOVERABLE | Recovery failed, manual reset needed |

## Error-to-Action Mapping

| Error | Action | Notes |
|-------|--------|-------|
| THERMAL_RUNAWAY | RETRY_AFTER_COOL | Cool to 60C, then retry |
| TEMP_TOO_HIGH | RETRY_AFTER_COOL | Cool to 60C, then retry |
| TEMP_SENSOR_FAIL | MANUAL_REQUIRED | User must check wiring |
| MOTOR_STALL_* | RETRY_ONCE | Up to 2 retries, then manual |
| FILAMENT_JAM | MANUAL_REQUIRED | User must clear jam |
| FILAMENT_OUT_* | MANUAL_REQUIRED | User must replace spool |
| CUTTER_FAIL | RETRY_ONCE | Single retry allowed |
| RECIPE_INVALID | ABORT | Cannot recover |
| SERIAL_TIMEOUT | RETRY_ONCE | Single retry allowed |
| EMERGENCY_STOP | RESET | Full system reset |

## Recovery Flow

```
Error Detected
    |
    v
ASSESSING (500ms delay)
    |
    +-- RETRY_ONCE ---------> RETRYING --> success? --> RESOLVED
    |                              |
    |                              +--> retries exhausted --> UNRECOVERABLE
    |
    +-- RETRY_AFTER_COOL --> COOLDOWN_WAIT --> temp ok? --> RETRYING
    |                              |
    |                              +--> timeout --> UNRECOVERABLE
    |
    +-- MANUAL_REQUIRED ---> AWAITING_USER --> CONFIRM --> RESOLVED
    |
    +-- ABORT/RESET -------> UNRECOVERABLE
```

## Serial Commands

```
RECOVER               Status of current recovery
RECOVER BEGIN         Start recovery for current error
RECOVER CONFIRM       Confirm manual intervention complete
RECOVER ABORT         Abort recovery and clear error
RECOVER STATS         Show recovery statistics
RECOVER RESET_STATS   Reset statistics counters
RECOVER CONFIG        Show current config
RECOVER CONFIG <retries> <cooldownMs> <cooldownC>
```

## Configuration

| Parameter | Default | Description |
|-----------|---------|-------------|
| max_retries | 3 | Maximum retry attempts |
| cooldown_timeout_ms | 60000 | Max wait for cooldown |
| cooldown_target_c | 60.0 | Temperature target for retry |
| assessment_delay_ms | 500 | Delay before action decision |
| retry_delay_ms | 1000 | Delay between retries |

## Statistics

The recovery engine tracks:
- Total errors encountered
- Automatic recoveries (successful retries)
- User-guided recoveries (manual confirmations)
- Unrecoverable errors
- Total retry attempts
- Aborted jobs
- Average recovery time (ms)

## Validation

```bash
python3 scripts/hardware/validate_f3_4.py
python3 -m unittest postprocessor.tests.test_error_recovery_validation -v
```
